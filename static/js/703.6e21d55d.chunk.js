"use strict";(self.webpackChunkexcel_viewer=self.webpackChunkexcel_viewer||[]).push([[703],{9703:(e,t,a)=>{a.d(t,{ExportPanel:()=>y});var l=a(9950),s=a(7840),r=a(1514),n=a(9654),c=a(1122),o=a(5369),i=a(5333),d=a(495),u=a(5355),h=a(3072),x=a(2678),p=a(8114),m=a(5271);class f{static async exportData(e,t,a){const l=e.worksheets[e.activeSheet];switch(t.format){case"xlsx":return this.exportToExcel(l,t,a);case"csv":return this.exportToCSV(l,t,a);case"json":return this.exportToJSON(l,t,a);default:throw new Error("\u4e0d\u652f\u6301\u7684\u5bfc\u51fa\u683c\u5f0f: ".concat(t.format))}}static async exportToExcel(e,t,a){const l=this.getExportData(e,t,a),s=m.Wp.book_new(),r=m.Wp.aoa_to_sheet(l),n=this.calculateColumnWidths(l);r["!cols"]=n,m.Wp.book_append_sheet(s,r,e.name);const c=m.M9(s,{bookType:"xlsx",type:"array"});return new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}static async exportToCSV(e,t,a){const l=this.getExportData(e,t,a),s=this.arrayToCSV(l);return new Blob([s],{type:"text/csv;charset=utf-8"})}static async exportToJSON(e,t,a){const l=this.getExportData(e,t,a),s=this.arrayToJSON(l,e.headers);return new Blob([JSON.stringify(s,null,2)],{type:"application/json"})}static getExportData(e,t,a){let l=0,s=0,r=e.rowCount-1,n=e.colCount-1;if("selected"===t.range)a&&(l=a.startRow,s=a.startCol,r=a.endRow,n=a.endCol);const c=[];if(t.includeHeaders&&e.headers){const a=t.selectedColumns?t.selectedColumns.map(t=>e.headers[t]):e.headers.slice(s,n+1);c.push(a)}for(let i=l;i<=r;i++){const a=[];for(let l=s;l<=n;l++){var o;if(t.selectedColumns&&!t.selectedColumns.includes(l))continue;const s=null===(o=e.data[i])||void 0===o?void 0:o[l];s?a.push(this.formatCellValue(s)):a.push("")}c.push(a)}return c}static formatCellValue(e){return"empty"===e.type?"":"date"===e.type&&e.value instanceof Date?e.value.toISOString():"formula"===e.type&&e.formula?e.formula:e.value}static calculateColumnWidths(e){if(0===e.length)return[];const t=e[0].length,a=[];for(let l=0;l<t;l++){let t=10;for(let a=0;a<e.length;a++){const s=String(e[a][l]||"");t=Math.max(t,s.length)}a.push({wch:Math.min(t,50)})}return a}static arrayToCSV(e){return e.map(e=>e.map(e=>{const t=String(e||"");return t.includes(",")||t.includes('"')||t.includes("\n")?'"'.concat(t.replace(/"/g,'""'),'"'):t}).join(",")).join("\n")}static arrayToJSON(e,t){if(0===e.length)return[];const a=[];for(let l=t?1:0;l<e.length;l++){const s={};for(let a=0;a<e[l].length;a++){s[(null===t||void 0===t?void 0:t[a])||"column_".concat(a)]=e[l][a]}a.push(s)}return a}static downloadFile(e,t){const a=URL.createObjectURL(e),l=document.createElement("a");l.href=a,l.download=t,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a)}static estimateFileSize(e,t,a){const l=this.getExportData(e,t,a),s=JSON.stringify(l);switch(t.format){case"xlsx":return Math.round(1.5*s.length);case"csv":return Math.round(.8*s.length);default:return s.length}}static generateFileName(e,t){const a=e.fileName.replace(/\.[^/.]+$/,""),l=(new Date).toISOString().slice(0,19).replace(/:/g,"-");switch(t.format){case"xlsx":return"".concat(a,"_export_").concat(l,".xlsx");case"csv":return"".concat(a,"_export_").concat(l,".csv");case"json":return"".concat(a,"_export_").concat(l,".json");default:return"".concat(a,"_export_").concat(l,".txt")}}}var v=a(4424),j=a(4414);const{Option:g}=s.A,y=e=>{var t;let{visible:a,onClose:m}=e;const{excelData:y,currentWorksheet:C,selection:w}=(0,v.K)(),[b]=r.A.useForm(),[A,S]=(0,l.useState)([]),[k,N]=(0,l.useState)(0),_=(0,l.useCallback)(async()=>{if(y&&C)try{const e=await b.validateFields(),t={format:e.format,range:e.range,includeHeaders:e.includeHeaders,selectedColumns:e.selectedColumns,fileName:e.fileName||f.generateFileName(y,e)},a=await f.exportData(y,t,w||void 0);f.downloadFile(a,t.fileName),n.Ay.success("\u5bfc\u51fa\u6210\u529f\uff01"),m()}catch(e){n.Ay.error("\u5bfc\u51fa\u5931\u8d25\uff1a"+e.message)}},[y,C,w,b,m]),F=(0,l.useCallback)(async()=>{if(y&&C)try{const e=await b.validateFields(),t={format:e.format,range:e.range,includeHeaders:e.includeHeaders,selectedColumns:e.selectedColumns},a=await f.exportData(y,t,w||void 0),l=await a.text();if("json"===e.format){const e=JSON.parse(l);S([Object.keys(e[0]||{}),...e.slice(0,5)])}else if("csv"===e.format){const e=l.split("\n").slice(0,6);S(e.map(e=>e.split(",")))}else S([]);const s=f.estimateFileSize(C,t,w||void 0);N(s)}catch(e){n.Ay.error("\u9884\u89c8\u5931\u8d25\uff1a"+e.message)}},[y,C,w,b]),O=(0,l.useCallback)(e=>{b.setFieldsValue({format:e})},[b]),T=(0,l.useCallback)(e=>{b.setFieldsValue({range:e})},[b]);return y&&C?(0,j.jsxs)(c.A,{title:"\u5bfc\u51fa\u6570\u636e",open:a,onCancel:m,width:800,footer:[(0,j.jsx)(o.Ay,{onClick:m,children:"\u53d6\u6d88"},"cancel"),(0,j.jsx)(o.Ay,{icon:(0,j.jsx)(x.A,{}),onClick:F,children:"\u9884\u89c8"},"preview"),(0,j.jsx)(o.Ay,{type:"primary",icon:(0,j.jsx)(p.A,{}),onClick:_,children:"\u5bfc\u51fa"},"export")],children:[(0,j.jsxs)(r.A,{form:b,layout:"vertical",initialValues:{format:"xlsx",range:"all",includeHeaders:!0,fileName:f.generateFileName(y,{format:"xlsx",range:"all",includeHeaders:!0})},children:[(0,j.jsx)(r.A.Item,{label:"\u5bfc\u51fa\u683c\u5f0f",name:"format",rules:[{required:!0}],children:(0,j.jsxs)(s.A,{onChange:O,children:[(0,j.jsx)(g,{value:"xlsx",children:"Excel (.xlsx)"}),(0,j.jsx)(g,{value:"csv",children:"CSV (.csv)"}),(0,j.jsx)(g,{value:"json",children:"JSON (.json)"})]})}),(0,j.jsx)(r.A.Item,{label:"\u5bfc\u51fa\u8303\u56f4",name:"range",rules:[{required:!0}],children:(0,j.jsxs)(i.Ay.Group,{onChange:e=>T(e.target.value),children:[(0,j.jsx)(i.Ay,{value:"all",children:"\u5168\u90e8\u6570\u636e"}),(0,j.jsx)(i.Ay,{value:"current",disabled:!C,children:"\u5f53\u524d\u89c6\u56fe"}),(0,j.jsx)(i.Ay,{value:"selected",disabled:!w,children:"\u9009\u4e2d\u533a\u57df"})]})}),(0,j.jsx)(r.A.Item,{label:"\u5bfc\u51fa\u9009\u9879",children:(0,j.jsx)(d.A.Group,{children:(0,j.jsx)(d.A,{name:"includeHeaders",value:!0,children:"\u5305\u542b\u8868\u5934"})})}),(0,j.jsx)(r.A.Item,{label:"\u9009\u62e9\u5217",name:"selectedColumns",children:(0,j.jsx)(d.A.Group,{children:(0,j.jsx)("div",{style:{maxHeight:"200px",overflowY:"auto"},children:null===(t=C.headers)||void 0===t?void 0:t.map((e,t)=>(0,j.jsx)("div",{children:(0,j.jsx)(d.A,{value:t,children:e})},t))})})}),(0,j.jsx)(r.A.Item,{label:"\u6587\u4ef6\u540d",name:"fileName",children:(0,j.jsx)(u.A,{placeholder:"\u8bf7\u8f93\u5165\u6587\u4ef6\u540d"})}),k>0&&(0,j.jsx)(r.A.Item,{label:"\u9884\u4f30\u6587\u4ef6\u5927\u5c0f",children:(0,j.jsx)("div",{style:{color:"#666"},children:k<1024?"".concat(k," B"):k<1048576?"".concat((k/1024).toFixed(1)," KB"):"".concat((k/1024/1024).toFixed(1)," MB")})})]}),A.length>0&&(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)(h.A,{children:"\u9884\u89c8\u6570\u636e"}),(0,j.jsx)("div",{style:{maxHeight:"300px",overflow:"auto"},children:(0,j.jsx)("table",{style:{width:"100%",borderCollapse:"collapse"},children:(0,j.jsx)("tbody",{children:A.map((e,t)=>(0,j.jsx)("tr",{children:e.map((e,t)=>(0,j.jsx)("td",{style:{border:"1px solid #d9d9d9",padding:"4px 8px",fontSize:"12px",whiteSpace:"pre-wrap",wordBreak:"break-word",maxWidth:"200px",verticalAlign:"top"},children:e},t))},t))})})}),(0,j.jsx)("div",{style:{textAlign:"center",marginTop:8,color:"#666"},children:(0,j.jsx)("small",{children:"\u663e\u793a\u524d5\u884c\u6570\u636e"})})]})]}):null}}}]);